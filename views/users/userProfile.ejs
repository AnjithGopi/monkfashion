<%- include('../layouts/headerUser') -%>
<%- include('../layouts/mobileHeaderUser')-%>

    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/home" rel="nofollow">Home</a>
                    <span></span> Profile
                </div>
            </div>
        </div>
        <section class="pt-15 pb-15">
            <div class="container">
                <div class="row">
            
                    <div class="col-lg-12 ">
                        <div class="row">
                            <div class="col-md-4">

                                <div class="container mt-5 d-flex ">
                                    <div class="card p-3" style="width:400px; border-radius: 10px;">
                        
                                        <div class=" align-items-center">
                        
                                            <div class="image">
                                                 <img src="https://images.unsplash.com/photo-1522075469751-3a6694fb2f61?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=500&q=80" class="rounded" width="155" >
                                            </div>
                        
                                         <div class="ml-3 w-100">
                                            
                                           <h4 class="mb-0 mt-0"><%=user.name%></h4>
                                           <span><%=user.email %></span>
                                         </div>
                                        </div>
                                    </div>
                                     
                                 </div>

                                <div class="dashboard-menu">
                                    <ul class="nav flex-column" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false"><i class="fi-rs-settings-sliders mr-10"></i>Dashboard</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="account-detail-tab" data-bs-toggle="tab" href="#account-detail" role="tab" aria-controls="account-detail" aria-selected="true"><i class="fi-rs-user mr-10"></i>Account details</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="true"><i class="fi-rs-marker mr-10"></i>My Address</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab" aria-controls="orders" aria-selected="false"><i class="fi-rs-shopping-bag mr-10"></i>Orders</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#track-orders" role="tab" aria-controls="track-orders" aria-selected="false"><i class="fi-rs-shopping-cart-check mr-10"></i>Wallet</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="refferal-tab" data-bs-toggle="tab" href="#refferal" role="tab" aria-controls="track-refferal" aria-selected="false"><i class="fi-rs-shopping-cart-check mr-10"></i>Reffer & Earn</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="/logout"><i class="fi-rs-sign-out mr-10"></i>Logout</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-8 mx-auto">
                                <div class="tab-content dashboard-content">
                                    <div class="tab-pane fade active show" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">Hello <%=user.name%> </h5>
                                            </div>
                                            <div class="card-body">
                                                <p>From your account dashboard. you can easily check &amp; view your <a href="#">recent orders</a>, manage your <a href="#">shipping and billing addresses</a> and <a href="#">edit your password and account details.</a></p>
                                            </div>

                                            <% if(locals.error) { %>
                                            <div class="card-body">
                                              <h3>Error Occur at Backend !</h3>
                                                <h5><%= error %></h5>
                                            </div>
                                            <% } %>
                                          
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">Your Orders</h5>
                                            </div>
                                            <div class="card-body">
                                                <% if (order.length > 0) { %>
                                                    <% order.forEach((orderItem,index) => { %>
                                                <div class="table-responsive">
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>#SN</th>
                                                                <th scope="col">Order Id</th>
                                                                <!-- <th scope="col">Name</th> -->
                                                                <th scope="col">Total Amount</th>
                                                                <th scope="col">Payment Method</th>
                                                                <th scope="col">Date</th>
                                                                <th scope="col">Status</th>
                                                                <th scope="col">Order Status</th>
                                                                <!-- <th scope="col">Change</th> -->
                                                                <th scope="col" class="text-end"> Action </th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            
                                                           
                                                         
                                                            <tr>
                                                                <form action="">
                                                                <td><%=index+1%></td>
                                                                <td> <%= orderItem.orderId %></td>
                                                                <!-- <td><b>Leslie Alexander</b></td> -->
                                                                <!-- <td><template class="__cf_email__" data-cfemail="b7dbd2c4dbded2f7d2cfd6dac7dbd299d4d8da">[email&#160;protected]</template></td> -->
                                                                <td><%= orderItem.totalAmount %></td>
                                                                <td><span class="badge rounded-pill text-success"><%= orderItem.paymentMethod %></span></td>
                                                                <td><%=orderItem.orderDate.toLocaleDateString()%></td>
                                                                <td><span class="badge rounded-pill alert-warning"><%= orderItem.paymentStatus %></span></td>
                                                                <td><span class="badge rounded-pill alert-primary" id="orderStatus_<%=index%>"><%= orderItem.orderStatus %></span></td>
                                                                
                                                                <td class="text-end">
                                                                    <% if(  orderItem.orderStatus  !== 'Cancelled' ) { %>
                                                                    <% if(  orderItem.orderStatus  !== 'Delivered' ) { %>
                                                                    <a  class="btn btn-danger btn-md m-2 rounded font-sm" id="cancelOrderButton_<%=index%>" onclick="cancelOrder('<%=orderItem._id%>','<%= index %>')" style="background-color: brown;">Cancel Order</a>
                                                                    <% } else {  %>
                                                                    <a  class="btn btn-danger btn-md m-2 rounded font-sm" onclick="returnOrder('<%=orderItem._id%>','<%= index %>')" style="background-color: rgb(8, 89, 210);">Return Order</a>
                                                                    <%  }  } %>
                                                                    <a  class="btn btn-md m-2 rounded font-sm" href="/home/profile/order/orderDetails?id=<%=orderItem._id%>">View Details</a>
                                                                     <!-- dropdown //end -->
                                                                </td>
                                                            </tr>
                                                        </form>
                                                           
                                                           
                                                        </tbody>
                                                    </table>
                                                </div> <!-- table-responsive //end -->
                                                    <% }); %>
                                                    <%  } else { %>
                                                        <p>No Orders available</p>
                                                        <% } %>
                                                </div> <!-- card-body end// -->
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="track-orders-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">Wallet</h5>
                                            </div>
                                            <div class="card-body contact-from-area">
                                                
                                                <div class="row d-flex align-items-center ">
                                                   
                                                            <div class="input-style mb-20 ">
                                                                <h2>Balance</h2>
                                                                <h3 class="text-success">₹ <%= locals.wallet.balance ? wallet.balance : 0%></h3>
                                                            </div>                                                       
                                                    
                                                </div>
                                                <div class="card mb-4">
                                                    <header class="card-header">
                                                        <h4 class="card-title">Transaction History</h4>
                                                       
                                                    </header>
                                                    <div class="card-body">
                                                        <div class="table-responsive">
                                                            <div class="table-responsive">
                                                                <table class="table align-middle table-nowrap mb-0">
                                                                    <thead class="table-light">
                                                                        <tr>
                                                                            <th scope="col" class="text-center">
                                                                                <div class="form-check align-middle">
                                                                                    <input class="form-check-input" type="checkbox" id="transactionCheck01">
                                                                                    <label class="form-check-label" for="transactionCheck01"></label>
                                                                                </div>
                                                                            </th>
                                                                           
                                                                            <th class="align-middle" scope="col">Date</th>
                                                                            <th class="align-middle" scope="col">Total</th>
                                                                            <th class="align-middle" scope="col">Payment Status</th>
                                                                           
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        <% wallet.transaction.forEach((transaction)=>{ %>

                                                                        
                                                                            <tr>
                                                                                <td class="text-center">
                                                                                    <div class="form-check">
                                                                                        <input class="form-check-input" type="checkbox" id="transactionCheck02">
                                                                                        <label class="form-check-label" for="transactionCheck02"></label>
                                                                                    </div>
                                                                                </td>
                                                                                <!-- <td><a href="#" class="fw-bold">#SK2540</a> </td> -->
                                                                                
                                                                                <td>
                                                                                    <%=transaction.createdOn.toLocaleDateString() %> 
                                                                                </td>
                                                                                <% if(transaction.mode == "Credited") { %>
                                                                                <td>
                                                                                 <span class="text-success">+ <%=transaction.amount %>  </span>
                                                                                </td>
                                                                                <td>
                                                                                    <span class="rounded-circle alert-success">Credited</span>
                                                                                    
                                                                                   
                                                                                    <!-- <span class="rounded-circle alert-danger">Debited</span> -->
                                                                                   
                                                                                </td>
                                                                                <% } else { %>
                                                                                    <td>
                                                                                        <span class="text-danger">- <%=transaction.amount %>  </span>
                                                                                       </td>
                                                                                       <td>
                                                                                           <span class="rounded-circle alert-danger">Debited</span>
                                                                                       </td>
                                                                                    <% } %>
                                                                                
                                                                            </tr>
                                                                           
                                                                       <%  })%>

                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div> <!-- table-responsive end// -->
                                                    </div>
                                                </div>
                                            </div>
                                            
                                        </div>
                                    </div>

                                    <!-- Refer and Earn -->
                                 <div class="tab-pane fade" id="refferal" role="tabpanel" aria-labelledby="refferal-tab">
                                     <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Referral & Earn</h5>
                                        </div>
                                        <div class="card-body contact-form-area">
                                            <div class="row d-flex align-items-center">
                                                <div class="col-md-12">
                                                    <div class="mb-20">
                                                        <h2 class="h4">Your Referral ID</h2>
                                                        <h3 class="text-success h5"><%= user.referralId %></h3>
                                                    </div>
                                                    <div class="mb-20">
                                                        <h2 class="h4">Share the Love</h2>
                                                        <p class="small">Invite your friends using your referral ID and earn rewards! They get benefits, and so do you.</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-12">
                                                    <!-- Add a referral link generator or sharing options here -->
                                                    <h2 class="h4">Your Referral Link</h2>
                                                    <p class="small">Share this link with your friends:</p>
                                                    <div class="input-group mb-3">
                                                        <input type="text" class="form-control small" value="https://monkfashion.shop/register?ref=<%= user.referralId %>" readonly>
                                                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="copyReferralLink()">Copy</button>
                                                    </div>
                                                    <div class="mb-20">
                                                        <h2 class="h4">Referral Rewards</h2>
                                                        <p class="small">For each friend who signs up using your referral link:</p>
                                                        <ul class="list-unstyled small">
                                                            <li><h6>You earn: 100</h6></li>
                                                            <li><h6>Your friend earns: 500</h6></li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                 </div>

                                    <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                                        <div class="row">
                                            <div class="ship_detail ml-20">
                                                <div class="form-group">
                                                    <div class="chek-form">
                                                        <div class="custome-checkbox">
                                                            <input class="form-check-input" type="checkbox" name="checkbox" id="differentaddress" />
                                                            <label class="form-check-label label_info" data-bs-toggle="collapse"
                                                                data-target="#collapseAddress" href="#collapseAddress"
                                                                aria-controls="collapseAddress" for="differentaddress"><span
                                                                    class="text-success font-size-lg font-weight-bold">Add New
                                                                    address</span></label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div id="collapseAddress" class="different_address collapse in ml-10">
                                                    <form action="/home/profile/addAddress" method="post">
                                                        <div class="">
                                                            <label for="name">Name :</label>
                                                            <input type="text" required="" name="fname" placeholder="First name *" />
                                                        </div>
                                                        <div class="">
                                                            <label for="phoneNumber">Phone Number:</label>
                                                            <input type="tel" id="phone" name="phoneNumber" pattern="[0-9]{10}"
                                                                placeholder="Enter your phone number *" required />
                                                        </div>
                                                        <div class="">
                                                            <label for="altphoneNumber">Alternate Number:</label>
                                                            <input type="tel" id="phone2" name="phone2" pattern="[0-9]{10}"
                                                                placeholder="Alternate phone number" />
                                                        </div>
                                                        <div class="">
                                                            <label for="houseName">House Name</label>
                                                            <input required="" type="text" name="cname" placeholder="House no / Name" />
                                                        </div>
                            
                                                        <div class="">
                                                            <label for="city">City</label>
                                                            <input required="" type="text" name="city" placeholder="City / Town *" />
                                                        </div>
                                                        <div class="">
                                                            <label for="state">State</label>
                                                            <input required="" type="text" name="state" placeholder="State / County *" />
                                                        </div>
                                                        <div class="">
                                                            <label for="pincode">Pincode</label>
                                                            <input required="" type="text" name="pincode" pattern="[0-9]{6}"
                                                                placeholder="Postcode / ZIP *" />
                                                        </div>
                                                        <div class="">
                                                            <label for="LandMark">Land Mark</label>
                                                            <input type="text" name="landMark" placeholder="Add Land mark" />
                                                        </div>
                                                        <div class=" ml-10">
                                                            <button type="submit" onclick="validateForm()">
                                                                Add new address
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                            
                                            <% if(user.address.length > 0) { %>
                                            <% for (let i = 0 ; i < user.address.length ; i++ ) {%>
                                            <div class="col-lg-6" id="tableRow_<%=i%>">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h5 class="mb-0"> Address <%= i+1%></h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <address><%= user.address[i].fullName %>
                                                          <br><%=user.address[i].houseName %> , <%= user.address[i].city %>,<%= user.address[i].state %><br><%= user.address[i].phone %> <br> <%= user.address[i].pincode %></br> </address>
                                                        <p></p>
                                                        <a href="/home/profile/editAddress?id=<%=user.address[i]._id %>&index=<%=i%>" class="btn-small">Edit</a>
                                                        <!-- <button type="button" class="btn btn-sm btn-danger delete-icon position-absolute bottom-0 end-0">
                                                            <i class="fi-rs-trash"></i>
                                                        </button> --> 
                                                        <a  class="text-muted position-absolute bottom-0 end-0 " onclick="removeAddress('<%= i%>')" ><i class="fi-rs-trash p-3"></i></a>
                                                    </div>
                                                </div>
                                            </div>
                                            <% } } else {%>
                                                <h3>No address available</h3>
                                                <% } %>

                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="account-detail" role="tabpanel" aria-labelledby="account-detail-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5>Account Detaills</h5>
                                            </div>
                                            <div class="card-body">
                                                <!-- <p>Already have an account? <a href="page-login-register.html">Log in instead!</a></p> -->
                                         
                                                    <div class="row">
                                                        <div class="form-group col-md-6">
                                                            <label> Name <span class="required">*</span></label>
                                                            <input required=" " value="<%= user.name %>" class="form-control square" name="name" type="text">
                                                        </div>
                                                       
                                                        <div class="form-group col-md-12">
                                                            <label>Email Address <span class="required">*</span></label>
                                                            <input required="" value= "<%= user.email %>" class="form-control square" name="email" type="email">
                                                        </div>
                                                        <div class="form-group col-md-12">
                                                            <label>Mobile Number <span class="required">*</span></label>
                                                            <input required=""  value="<%= user.mobile %>" class="form-control square" name="password" type="tel">
                                                        </div>
                                                        <% if (user.address.length > 0) { %>
                                                        <div class="form-group col-md-12">
                                                            <label>Address <span class="required">*</span></label>
                                                            <div class="card">
                                                                <div class="card-header">
                                                                    <h5 class="mb-0">
                                                                        <%= user.address[0].fullName %>
                                                                    </h5>
                                                                </div>
                                                                <div class="card-body">
                                                                    <address>
                                                                        <%=user.address[0].houseName %> &nbsp; <%= user.address[0].city %>
                                                                                <%=user.address[0].state %> <br />
                                                                                    <%= user.address[0].pincode %>
                                                                                        <br />
                                                                                        <%=user.address[0].phone %>
                                                                    </address>
                                                                    <% if( user.address[0].landMark) { %>
                                                                        <p>
                                                                            <%= user.address[0].landMark %>
                                                                        </p>
                                                                        <% } %>
                                                                </div>
                                                            </div>                                                       
                                                         </div>
                                                       
                                                            <% }  else {%>
                                                                <h3>No address available</h3>
                                                                <% } %>
                                                        <div class="col-md-12">
                                                            <!-- <button type="button"  class="btn btn-fill-out submit" name="submit" value="Submit">Save</button> -->
                                                            <a type="button" href="/home/profile/changePassword" class="btn btn-fill-out submit" name="submit" value="Submit">Change Password</a>
                                                            <a type="button" href="/home/profile/editProfile" class="btn btn-fill-out submit  position-absolute bottom-0 end-0 " name="submit" value="Submit">Update Profile</a>
                                                               
                                                        </div>
                                                    </div>
                                              
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    
    <%- include('../layouts/footerUser') -%>

     <!-- Toastr message -->

    <% if (locals.successMessage) { %>
        <script>
        toastr.success('<%=successMessage%>');
    </script>
    <% } %>
  
    <% if (locals.failedMessage) { %>
        <script>
        toastr.error('<%=failedMessage%>');
    </script>
    <% } %>

    <% if (locals.errorMessage) { %>
        <script>
        // toastr.error('<%=errorMessage%>');
        Swal.fire({
        title: 'Warning!',
        text: '<%=error%>' ,
        icon: 'warning',
        confirmButtonText: 'Okay'
    });
    </script>
    <% } %>

    <script>
        function cancelOrder(id,index) {
            console.log("Id; ",id,"index :",index)
           
           
            // toastr.success("hhhhhhh")
            Swal.fire({
            title: "Are you sure to Cancel your order",
            text: "You won't be able to revert this!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#046963",
            cancelButtonColor: "#d33",
            confirmButtonText: "Cancel Order"
            }).then((result) => {
            if (result.isConfirmed) {
                fetch('/home/profile/cancelOrder',{
                method:'post',
                headers:{
                    'Content-Type':'application/json',
                },
                body:JSON.stringify({
                    orderId:id,
                    index:index,
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log("the response recieved");
                if(data.message){
                    toastr.success(data.message)
                }
                if(data.successMessage){
                     toastr.success(data.successMessage)
                     document.getElementById(`orderStatus_${index}`).innerText = "Cancelled";
                     document.getElementById(`cancelOrderButton_${index}`).style.display="none";
                    //  console.log('Changed order status :',data.changedOrderStatus)
                    // changeColor(data.changedOrderStatus,index)
                }
                if(data.errorMessage){
                    toastr.success(data.errorMessage)
                }
            })
            .catch(error => {
                console.error('Error updating quantity:', error);
            });
             }
        })
        }
     </script>


    <script>
        function validateForm() {
            // Reset error messages
            document.getElementById("nameError").textContent = "";
            document.getElementById("phoneError").textContent = "";

            // Get form values
            var name = document.forms["addressForm"]["fname"].value;
            var phone = document.forms["addressForm"]["phoneNumber"].value;

            // Validate name
            if (name.trim() === "") {
                document.getElementById("nameError").textContent = "Name is required.";
            }

            // Validate phone number
            if (!/^[0-9]{10}$/.test(phone)) {
                document.getElementById("phoneError").textContent =
                    "Please enter a valid phone number.";
            }

            // Add similar validation for other fields

            // If any error messages are present, prevent form submission
            if (
                document.getElementById("nameError").textContent ||
                document.getElementById("phoneError").textContent
            ) {
                event.preventDefault();
            }
        }

 // Function to remove address from user profile
    function removeAddress(index) {
        // Make a fetch request to the server to remove the item from the cart
        fetch(`/remove-address/${index}`, {
            method: 'DELETE',
        })
        .then(response => {
            console.log('response of remove address received')
            console.log(response)
            if (response.ok) {
            console.log('ok worked')
               
        toastr.success('Address removed successfully.');

                document.getElementById(`tableRow_${index}`).remove();
                updateTotal()
            } else {
                console.error('Failed to remove address.');
                 toastr.error('Failed to remove address.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    function copyReferralLink() {
        // Select the text in the input field
        var referralLinkInput = document.querySelector('.form-control');
        referralLinkInput.select();
        referralLinkInput.setSelectionRange(0, 99999); // For mobile devices

        // Copy the selected text to the clipboard
        document.execCommand('copy');

        // Deselect the text
        referralLinkInput.setSelectionRange(0, 0);

        // Optionally, you can provide user feedback
        toastr.success('Referral link copied to clipboard!');
    }

    </script>